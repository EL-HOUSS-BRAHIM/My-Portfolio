class TestimonialController{constructor(t="./src/api",e=8e3){this.apiBaseUrl=t,this.autoSlideInterval=e,this.currentTestimonial=0,this.testimonials=[],this.numVisibleCards=3,this.autoSlideTimer=null,this.isAutoPaused=!1,this.elements={slider:document.querySelector(".testimonial-slider"),prevButton:document.getElementById("prevTestimonial"),nextButton:document.getElementById("nextTestimonial"),addButton:document.getElementById("addTestimonialBtn"),formContainer:document.getElementById("testimonialFormContainer"),form:document.getElementById("testimonialForm")},this.init()}init(){this.elements.slider?(this.setupEventListeners(),this.setupResponsiveCards(),this.fetchTestimonials(),console.debug("[TestimonialController] Initialized")):console.warn("[TestimonialController] Testimonial slider not found")}setupEventListeners(){this.elements.prevButton&&this.elements.prevButton.addEventListener("click",()=>this.showPrevTestimonial()),this.elements.nextButton&&this.elements.nextButton.addEventListener("click",()=>this.showNextTestimonial()),this.elements.addButton&&this.elements.addButton.addEventListener("click",()=>this.toggleForm()),this.elements.form&&this.elements.form.addEventListener("submit",t=>this.handleFormSubmit(t)),this.elements.formContainer&&this.elements.formContainer.addEventListener("click",t=>{t.target===this.elements.formContainer&&this.toggleForm()}),window.addEventListener("resize",this.debounce(()=>{this.setupResponsiveCards(),this.updateSliderPosition()},250)),this.elements.slider&&(this.elements.slider.addEventListener("mouseenter",()=>this.pauseAutoSlide()),this.elements.slider.addEventListener("mouseleave",()=>this.resumeAutoSlide())),document.addEventListener("keydown",t=>this.handleKeyboardNavigation(t)),this.setupTouchSupport()}setupResponsiveCards(){const t=window.innerWidth,e=this.testimonials.length;this.numVisibleCards=t<768?1:t<1024?Math.min(e,2):e<=3?e:3,this.numVisibleCards>=e?(this.stopAutoSlide(),this.currentTestimonial=0):null===this.autoSlideTimer&&e>1&&this.startAutoSlide(),this.updateSliderPosition(),this.updateNavigationButtons()}async fetchTestimonials(){if(this.isDevMode())this.loadSampleTestimonials();else try{const t=await fetch(`${this.apiBaseUrl}/get_testimonials.php`);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const e=await t.json();if(!e.success)throw new Error(e.message||"API returned unsuccessful response");e.data&&Array.isArray(e.data.testimonials)?this.testimonials=e.data.testimonials:Array.isArray(e.testimonials)?this.testimonials=e.testimonials:this.testimonials=[],this.setupResponsiveCards(),this.displayTestimonials(),this.updateNavigationButtons(),this.startAutoSlide(),console.log("[TestimonialController] Successfully loaded",this.testimonials.length,"testimonials")}catch(t){console.error("[TestimonialController] Fetch error:",t),this.showDatabaseError(t.message)}}isDevMode(){return"localhost"===location.hostname||"127.0.0.1"===location.hostname||""===location.hostname}loadSampleTestimonials(){this.testimonials=[{id:1,name:"Sarah Johnson",image:"assets/images/testimonials/sarah.jpg",rating:5,testimonial:"Brahim delivered exceptional work on our web application. His attention to detail and technical expertise made the project a huge success.",created_at:"2024-01-15"},{id:2,name:"Michael Chen",image:"",rating:5,testimonial:"Working with Brahim was a fantastic experience. He's professional, communicative, and delivers high-quality code on time.",created_at:"2024-02-01"},{id:3,name:"Emily Rodriguez",image:"assets/images/testimonials/emily.jpg",rating:5,testimonial:"Brahim's full-stack development skills are impressive. He transformed our ideas into a beautiful, functional website that exceeded our expectations. The attention to detail and the quality of the code were outstanding. I would definitely work with him again.",created_at:"2024-02-15"},{id:4,name:"David Thompson",image:"assets/images/testimonials/david.jpg",rating:4,testimonial:"Great developer!",created_at:"2024-03-01"}],this.setupResponsiveCards(),this.displayTestimonials(),this.updateNavigationButtons(),this.startAutoSlide()}displayTestimonials(){if(!this.elements.slider)return void this.showEmptyState();if(0===this.testimonials.length)return void this.showEmptyState();const t=document.querySelector(".testimonials");t&&t.setAttribute("data-count",this.testimonials.length);const e=this.testimonials.map(t=>this.createTestimonialHTML(t)).join("");this.elements.slider.innerHTML=e,setTimeout(()=>{this.updateSliderPosition(),this.handleSingleTestimonial()},100)}handleSingleTestimonial(){1===this.testimonials.length?(this.stopAutoSlide(),this.elements.prevButton&&(this.elements.prevButton.style.display="none"),this.elements.nextButton&&(this.elements.nextButton.style.display="none"),this.elements.slider.style.justifyContent="center"):(this.elements.prevButton&&(this.elements.prevButton.style.display="flex"),this.elements.nextButton&&(this.elements.nextButton.style.display="flex"),this.elements.slider.style.justifyContent="flex-start")}createTestimonialHTML(t){const e=this.generateStars(t.rating),i=this.formatDate(t.created_at),s=this.escapeHtml(t.testimonial),n=this.escapeHtml(t.name),a=t.image_url||t.image||"",o=s.length;let l="medium";o<100?l="short":o>200&&(l="long");const r=a?`<img src="${a}" alt="${n}" loading="lazy" \n                 onerror="this.closest('.testimonial-image').classList.add('no-image'); this.style.display='none'; this.closest('.testimonial-image').innerHTML='<span>${n.charAt(0).toUpperCase()}</span>';">`:`<span>${n.charAt(0).toUpperCase()}</span>`,m=a?"testimonial-image":"testimonial-image no-image";return`\n            <div class="testimonial-item" data-id="${t.id}">\n                <div class="testimonial-content">\n                    <div class="testimonial-rating">\n                        ${e}\n                    </div>\n                    <blockquote class="testimonial-text ${l}">\n                        "${s}"\n                    </blockquote>\n                    <div class="testimonial-author">\n                        <div class="${m}">\n                            ${r}\n                        </div>\n                        <div class="testimonial-details">\n                            <h4 class="testimonial-name">${n}</h4>\n                            <time class="testimonial-date" datetime="${t.created_at}">\n                                ${i}\n                            </time>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `}generateStars(t){let e="";for(let i=1;i<=5;i++)e+=i<=t?'<i class="fas fa-star"></i>':'<i class="far fa-star"></i>';return e}formatDate(t){try{return new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}catch(e){return t}}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}updateSliderPosition(){if(!this.elements.slider||0===this.testimonials.length)return;const t=this.elements.slider.querySelector(".testimonial-item");if(!t)return;window.getComputedStyle(t);const e=t.offsetWidth+(parseInt(window.getComputedStyle(this.elements.slider).gap)||24),i=-this.currentTestimonial*e;this.elements.slider.style.transform=`translateX(${i}px)`,this.elements.slider.style.transition="transform 0.5s cubic-bezier(0.4, 0, 0.2, 1)"}showNextTestimonial(){if(0===this.testimonials.length)return;const t=Math.max(0,this.testimonials.length-this.numVisibleCards);this.currentTestimonial=Math.min(this.currentTestimonial+1,t),this.updateSliderPosition(),this.updateNavigationButtons()}showPrevTestimonial(){0!==this.testimonials.length&&(this.currentTestimonial=Math.max(this.currentTestimonial-1,0),this.updateSliderPosition(),this.updateNavigationButtons())}updateNavigationButtons(){if(!this.elements.prevButton||!this.elements.nextButton)return;const t=this.testimonials.length,e=Math.max(0,t-this.numVisibleCards);if(t<=1||t<=this.numVisibleCards)return this.elements.prevButton.style.display="none",void(this.elements.nextButton.style.display="none");this.elements.prevButton.style.display="flex",this.elements.nextButton.style.display="flex",this.elements.prevButton.disabled=0===this.currentTestimonial,this.elements.nextButton.disabled=this.currentTestimonial>=e;const i=Math.floor(this.currentTestimonial/this.numVisibleCards)+1,s=Math.ceil(t/this.numVisibleCards);this.elements.prevButton.setAttribute("aria-label",`Previous testimonials (Page ${i} of ${s})`),this.elements.nextButton.setAttribute("aria-label",`Next testimonials (Page ${i} of ${s})`),this.elements.prevButton.disabled?(this.elements.prevButton.style.opacity="0.3",this.elements.prevButton.style.cursor="not-allowed"):(this.elements.prevButton.style.opacity="1",this.elements.prevButton.style.cursor="pointer"),this.elements.nextButton.disabled?(this.elements.nextButton.style.opacity="0.3",this.elements.nextButton.style.cursor="not-allowed"):(this.elements.nextButton.style.opacity="1",this.elements.nextButton.style.cursor="pointer")}startAutoSlide(){this.testimonials.length<=1||this.testimonials.length<=this.numVisibleCards||(this.stopAutoSlide(),this.autoSlideTimer=setInterval(()=>{if(!this.isAutoPaused){const t=Math.max(0,this.testimonials.length-this.numVisibleCards);this.currentTestimonial>=t?this.currentTestimonial=0:this.currentTestimonial++,this.updateSliderPosition(),this.updateNavigationButtons()}},this.autoSlideInterval))}stopAutoSlide(){this.autoSlideTimer&&(clearInterval(this.autoSlideTimer),this.autoSlideTimer=null)}pauseAutoSlide(){this.isAutoPaused=!0}resumeAutoSlide(){this.isAutoPaused=!1}handleKeyboardNavigation(t){const e=this.elements.formContainer&&!this.elements.formContainer.classList.contains("hidden");if(e&&"Escape"===t.key)return t.preventDefault(),void this.toggleForm();if(t.target.closest(".testimonials")&&!e)switch(t.key){case"ArrowLeft":t.preventDefault(),this.showPrevTestimonial();break;case"ArrowRight":t.preventDefault(),this.showNextTestimonial();break;case"Home":t.preventDefault(),this.currentTestimonial=0,this.updateSliderPosition(),this.updateNavigationButtons();break;case"End":t.preventDefault(),this.currentTestimonial=Math.max(0,this.testimonials.length-this.numVisibleCards),this.updateSliderPosition(),this.updateNavigationButtons()}}setupTouchSupport(){if(!this.elements.slider)return;let t=0,e=0;this.elements.slider.addEventListener("touchstart",e=>{t=e.touches[0].clientX}),this.elements.slider.addEventListener("touchend",i=>{e=i.changedTouches[0].clientX,this.handleSwipe(t,e)})}handleSwipe(t,e){const i=t-e;Math.abs(i)>50&&(i>0?this.showNextTestimonial():this.showPrevTestimonial())}toggleForm(){if(!this.elements.formContainer)return;this.elements.formContainer.classList.contains("hidden")?(this.elements.formContainer.classList.remove("hidden"),this.elements.formContainer.classList.add("show"),this.elements.addButton.textContent="Cancel",setTimeout(()=>{const t=this.elements.form?.querySelector("input");t&&t.focus()},300)):(this.elements.formContainer.classList.add("hidden"),this.elements.formContainer.classList.remove("show"),this.elements.addButton.textContent="Add Your Testimonial")}async handleFormSubmit(t){if(t.preventDefault(),this.isDevMode())return void alert("Testimonial form submission is disabled in development mode.");if("undefined"!=typeof grecaptcha){if(!grecaptcha.getResponse())return void alert("Please complete the reCAPTCHA verification.")}const e=new FormData(this.elements.form);try{const t=await fetch(`${this.apiBaseUrl}/add_testimonial.php`,{method:"POST",body:e}),i=await t.json();i.success?(alert("Thank you for your testimonial! It will be reviewed before being published."),this.elements.form.reset(),"undefined"!=typeof grecaptcha&&grecaptcha.reset(),this.toggleForm()):alert(i.message||"Failed to submit testimonial. Please try again.")}catch(t){console.error("[TestimonialController] Form submission error:",t),alert("An error occurred. Please try again later.")}}showEmptyState(){this.elements.slider&&(this.elements.slider.innerHTML='\n            <div class="testimonials-empty">\n                <div class="empty-icon">\n                    <i class="fas fa-comments"></i>\n                </div>\n                <h3>No testimonials yet</h3>\n                <p>Be the first to share your experience!</p>\n            </div>\n        ')}showDatabaseError(t="Unable to load testimonials"){this.elements.slider&&(this.elements.slider.innerHTML=`\n            <div class="testimonials-error">\n                <div class="error-icon">\n                    <i class="fas fa-exclamation-triangle"></i>\n                </div>\n                <h3>Testimonials Unavailable</h3>\n                <p>${t}</p>\n                <button onclick="window.location.reload()" class="btn btn--secondary">\n                    Try Again\n                </button>\n            </div>\n        `)}debounce(t,e){let i;return function(...s){clearTimeout(i),i=setTimeout(()=>{clearTimeout(i),t(...s)},e)}}handleResize(){this.setupResponsiveCards()}handleVisibilityChange(t){t?this.resumeAutoSlide():this.pauseAutoSlide()}destroy(){this.stopAutoSlide(),window.removeEventListener("resize",this.handleResize),document.removeEventListener("keydown",this.handleKeyboardNavigation)}}